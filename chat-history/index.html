<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Chat History | Davidson & Co London</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;700&family=Manrope:wght@200;300;400;500&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              black: '#080808',
              charcoal: '#121212',
              gold: '#D4AF37',
              goldDim: '#8A7120',
              stone: '#1c1c1c',
              white: '#F5F5F5'
            }
          },
          fontFamily: {
            serif: ['Cinzel', 'serif'],
            sans: ['Manrope', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    body {
      background-color: #080808;
      color: #F5F5F5;
      -webkit-font-smoothing: antialiased;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #121212;
    }

    ::-webkit-scrollbar-thumb {
      background: #D4AF37;
      border-radius: 3px;
    }

    .grain-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
    }

    .message-item {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .image-thumbnail {
      max-width: 200px;
      max-height: 200px;
      object-fit: cover;
    }
  </style>
</head>

<body class="relative font-sans min-h-screen">

  <!-- Cinematic Grain Overlay -->
  <div class="grain-overlay"></div>

  <!-- Header -->
  <header class="fixed top-0 left-0 right-0 z-40 bg-brand-black/90 backdrop-blur-sm border-b border-white/5">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3">
        <img src="/logo.png" alt="Davidson & Co." class="h-8 sm:h-10">
      </a>
      <div class="flex items-center gap-4">
        <button onclick="clearChatHistory()" class="text-xs text-gray-400 hover:text-red-400 transition-colors flex items-center gap-1.5" title="Clear chat history">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
          </svg>
          <span class="hidden sm:inline">Clear</span>
        </button>
        <a href="/admin" class="text-xs text-gray-400 hover:text-brand-gold transition-colors flex items-center gap-1.5">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
          </svg>
          <span class="hidden sm:inline">Back to Chat</span>
        </a>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="pt-24 pb-12 px-4 sm:px-6 max-w-4xl mx-auto">

    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-3xl sm:text-4xl font-serif text-brand-white mb-2">Chat History</h1>
      <p class="text-gray-400 text-sm">Review your AI assistant conversations</p>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="flex items-center justify-center py-16">
      <div class="flex flex-col items-center gap-4">
        <svg class="w-8 h-8 text-brand-gold animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        <span class="text-gray-400 text-sm">Loading chat history...</span>
      </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden flex flex-col items-center justify-center py-16 text-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 text-gray-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
      </svg>
      <h3 class="text-xl font-serif text-gray-400 mb-2">No Chat History</h3>
      <p class="text-gray-500 text-sm max-w-md">Start a conversation with the AI assistant to see your chat history here.</p>
      <a href="/admin" class="mt-6 px-4 py-2 bg-brand-gold/20 hover:bg-brand-gold/30 text-brand-gold text-sm rounded-lg transition-colors">
        Go to Chat
      </a>
    </div>

    <!-- Chat Messages Container -->
    <div id="chatHistory" class="hidden space-y-4">
      <!-- Messages will be rendered here by JavaScript -->
    </div>

  </main>

  <script>
    // LocalStorage keys (same as admin/index.html)
    const MESSAGES_KEY = 'davidson_chat_messages';

    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    const chatHistory = document.getElementById('chatHistory');

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Format message content with markdown support
    function formatMessage(text) {
      let formatted = escapeHtml(text);

      // Bold (**text**)
      formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong class="text-brand-white">$1</strong>');

      // Italic (*text*)
      formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');

      // Inline code (`code`)
      formatted = formatted.replace(/`(.*?)`/g, '<code class="bg-brand-stone px-1 rounded text-brand-gold">$1</code>');

      // Links [text](url) - only allow http/https/relative paths
      formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, text, url) => {
        if (/^(https?:\/\/|\/)/i.test(url)) {
          return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-brand-gold hover:text-brand-gold/80 underline transition-colors">${text}</a>`;
        }
        return text;
      });

      // Headings
      formatted = formatted.replace(/^## (.+)$/gm, '<h2 class="text-lg font-serif text-brand-gold mt-4 mb-2">$1</h2>');
      formatted = formatted.replace(/^### (.+)$/gm, '<h3 class="text-base font-serif text-brand-gold mt-3 mb-1">$1</h3>');

      // Bullet lists (- item or * item)
      formatted = formatted.replace(/^[*-] (.+)$/gm, '<li class="ml-4">â€¢ $1</li>');
      formatted = formatted.replace(/(<li class="ml-4">.*<\/li>\n?)+/g, '<ul class="my-2">$&</ul>');

      // Numbered lists (1. item)
      formatted = formatted.replace(/^\d+\. (.+)$/gm, '<li class="ml-4 list-decimal">$1</li>');
      formatted = formatted.replace(/(<li class="ml-4 list-decimal">.*<\/li>\n?)+/g, '<ol class="my-2 ml-4">$&</ol>');

      // Line breaks
      formatted = formatted.replace(/\n\n/g, '<br><br>');

      return formatted;
    }

    // Render a single message
    function renderMessage(msg) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message-item flex gap-3 sm:gap-4';

      if (msg.isUser) {
        // User message - right aligned with gold accent
        let imageThumbnails = '';
        if (msg.images && msg.images.length > 0) {
          imageThumbnails = `
            <div class="flex flex-wrap gap-2 mt-3">
              ${msg.images.map(img => `
                <div class="relative">
                  <img src="${img}" alt="Uploaded image" class="image-thumbnail rounded-lg border border-brand-gold/30">
                </div>
              `).join('')}
            </div>
          `;
        }

        messageDiv.innerHTML = `
          <div class="flex-1 bg-brand-gold/10 rounded-2xl rounded-tr-none p-4 sm:p-5 border border-brand-gold/20 ml-8 sm:ml-12">
            <p class="text-sm sm:text-base text-gray-200 leading-relaxed whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
            ${imageThumbnails}
          </div>
          <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-brand-stone flex items-center justify-center border border-white/10">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
            </svg>
          </div>
        `;
      } else {
        // AI message - left aligned with charcoal background
        messageDiv.innerHTML = `
          <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10">
            <img src="/secondary-logo.png" alt="Davidson AI" class="w-full h-full object-contain">
          </div>
          <div class="flex-1 bg-brand-charcoal rounded-2xl rounded-tl-none p-4 sm:p-5 border border-white/5 mr-8 sm:mr-12">
            <div class="text-sm sm:text-base text-gray-300 leading-relaxed">${formatMessage(msg.content)}</div>
          </div>
        `;
      }

      return messageDiv;
    }

    // Load and display chat history
    function loadChatHistory() {
      try {
        const savedMessages = localStorage.getItem(MESSAGES_KEY);

        loadingState.classList.add('hidden');

        if (!savedMessages) {
          emptyState.classList.remove('hidden');
          return;
        }

        const messages = JSON.parse(savedMessages);

        if (!messages || messages.length === 0) {
          emptyState.classList.remove('hidden');
          return;
        }

        // Show chat history container
        chatHistory.classList.remove('hidden');

        // Render each message
        messages.forEach(msg => {
          const messageElement = renderMessage(msg);
          chatHistory.appendChild(messageElement);
        });

        // Add message count indicator
        const countDiv = document.createElement('div');
        countDiv.className = 'mt-8 pt-8 border-t border-white/5 text-center';
        countDiv.innerHTML = `
          <p class="text-xs text-gray-500">
            ${messages.length} message${messages.length !== 1 ? 's' : ''} in history
          </p>
        `;
        chatHistory.appendChild(countDiv);

      } catch (error) {
        console.error('Error loading chat history:', error);
        loadingState.classList.add('hidden');
        emptyState.classList.remove('hidden');

        // Show error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'mt-4 p-4 bg-red-500/10 border border-red-500/30 rounded-lg text-center';
        errorDiv.innerHTML = `
          <p class="text-sm text-red-400">Error loading chat history. The data may be corrupted.</p>
        `;
        emptyState.appendChild(errorDiv);
      }
    }

    // Clear chat history
    function clearChatHistory() {
      if (!confirm('Are you sure you want to clear all chat history? This cannot be undone.')) {
        return;
      }

      try {
        localStorage.removeItem('davidson_chat_history');
        localStorage.removeItem(MESSAGES_KEY);

        // Reload the page to show empty state
        location.reload();
      } catch (error) {
        console.error('Error clearing chat history:', error);
        alert('Failed to clear chat history. Please try again.');
      }
    }
    window.clearChatHistory = clearChatHistory;

    // Load chat history when page loads
    document.addEventListener('DOMContentLoaded', loadChatHistory);
  </script>

</body>
</html>
