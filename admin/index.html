<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Davidson & Co London | AI Builder</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;700&family=Manrope:wght@200;300;400;500&display=swap"
    rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              black: '#080808',
              charcoal: '#121212',
              gold: '#D4AF37',
              goldDim: '#8A7120',
              stone: '#1c1c1c',
              white: '#F5F5F5'
            }
          },
          fontFamily: {
            serif: ['Cinzel', 'serif'],
            sans: ['Manrope', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    html, body {
      height: 100%;
    }

    body {
      background-color: #080808;
      color: #F5F5F5;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #121212;
    }

    ::-webkit-scrollbar-thumb {
      background: #D4AF37;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #8A7120;
    }

    .chat-container {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .message-appear {
      animation: fadeInUp 0.3s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Logo blur pulse animation for typing indicator */
    .typing-logo {
      animation: blurPulse 2s ease-in-out infinite;
    }

    @keyframes blurPulse {
      0%, 100% {
        opacity: 0.3;
        filter: blur(6px);
        transform: scale(0.95);
      }
      50% {
        opacity: 1;
        filter: blur(0);
        transform: scale(1);
      }
    }

    .grain-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
    }

    /* Blur fade-in letter animation */
    .blur-text-char {
      display: inline-block;
      opacity: 0;
      filter: blur(8px);
      animation: blurFadeIn 0.4s ease-out forwards;
    }

    .blur-text-char.animation-complete {
      opacity: 1 !important;
      filter: none !important;
      transform: none !important;
      animation: none !important;
    }

    .blur-text-char.space {
      width: 0.25em;
    }

    @keyframes blurFadeIn {
      0% {
        opacity: 0;
        filter: blur(8px);
        transform: translateY(5px);
      }
      100% {
        opacity: 1;
        filter: none;
        transform: translateY(0);
      }
    }

    /* Success checkmark animation */
    .success-checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: block;
      stroke-width: 2;
      stroke: #22c55e;
      stroke-miterlimit: 10;
      animation: successScale 0.4s ease-in-out 0.4s both;
    }

    .success-checkmark__circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 2;
      stroke-miterlimit: 10;
      stroke: #22c55e;
      fill: none;
      animation: successStroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }

    .success-checkmark__check {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: successStroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.5s forwards;
    }

    @keyframes successStroke {
      100% {
        stroke-dashoffset: 0;
      }
    }

    @keyframes successScale {
      0%, 100% {
        transform: none;
      }
      50% {
        transform: scale3d(1.1, 1.1, 1);
      }
    }

    /* Publish button pulse */
    .publish-btn {
      animation: publishPulse 2s ease-in-out infinite;
    }

    @keyframes publishPulse {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
      }
      50% {
        box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
      }
    }

    /* Blur poof vanish animation for clearing chat */
    .message-vanish {
      animation: blurPoofVanish 0.3s ease-out forwards;
    }

    @keyframes blurPoofVanish {
      0% {
        opacity: 1;
        filter: blur(0);
        transform: scale(1);
      }
      100% {
        opacity: 0;
        filter: blur(12px);
        transform: scale(0.8);
      }
    }
  </style>
</head>

<body class="relative font-sans">

  <!-- Cinematic Grain Overlay -->
  <div class="grain-overlay"></div>

  <!-- Header -->
  <header class="fixed top-0 left-0 right-0 z-40 bg-brand-black/90 backdrop-blur-sm border-b border-white/5">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3">
        <img src="/logo.png" alt="Davidson & Co." class="h-8 sm:h-10">
      </a>
      <div class="flex items-center gap-2 sm:gap-4">
        <a href="/activity" class="text-xs text-gray-400 hover:text-brand-gold transition-colors flex items-center gap-1.5" title="View activity log">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span class="hidden sm:inline">Activity</span>
        </a>
        <button onclick="clearChatHistory()" class="text-xs text-gray-400 hover:text-red-400 transition-colors flex items-center gap-1.5" title="Clear chat history">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
          </svg>
          <span class="hidden sm:inline">Clear</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Chat Interface -->
  <main class="pt-20 pb-4 px-4 sm:px-6 flex flex-col max-w-5xl mx-auto" style="height: 100%; height: 100dvh;">

    <!-- Chat Messages Container -->
    <div id="chatContainer" class="chat-container overflow-y-auto flex flex-col gap-4 py-6">

      <!-- Welcome Message -->
      <div class="message-appear flex gap-3 sm:gap-4">
        <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10">
          <img src="/secondary-logo.png" alt="Davidson" class="w-full h-full object-contain">
        </div>
        <div class="flex-1 bg-brand-charcoal rounded-2xl rounded-tl-none p-4 sm:p-5 border border-white/5">
          <p id="welcomeText" class="text-sm sm:text-base text-gray-300 leading-relaxed blur-text-container" data-text="Welcome to the Davidson & Co London website development assistant. What would you like me to help you build today?"></p>
        </div>
      </div>

    </div>

    <!-- Input Area -->
    <div class="flex-shrink-0 pt-4 border-t border-white/5">
      <!-- Upload Preview Area -->
      <div id="uploadPreview" class="hidden mb-3 flex flex-wrap gap-2">
      </div>
      <form id="chatForm" class="flex gap-2 sm:gap-3 items-center">
        <!-- Hidden file input -->
        <input type="file" id="imageInput" accept="image/*" multiple class="hidden">
        <!-- Upload button -->
        <button
          type="button"
          id="uploadButton"
          class="flex-shrink-0 w-12 h-12 sm:w-14 sm:h-14 bg-brand-charcoal border border-white/10 text-gray-400 rounded-xl flex items-center justify-center hover:border-brand-gold/50 hover:text-brand-gold transition-colors"
          title="Upload images"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 sm:w-6 sm:h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
          </svg>
        </button>
        <div class="flex-1 relative">
          <textarea
            id="messageInput"
            rows="1"
            placeholder="Type your message..."
            class="w-full bg-brand-charcoal border border-white/10 rounded-xl px-4 py-3 sm:py-4 text-base text-brand-white placeholder-gray-500 outline-none focus:border-brand-gold/50 transition-colors resize-none overflow-hidden"
            style="max-height: 120px;"
          ></textarea>
        </div>
        <button
          type="submit"
          id="sendButton"
          class="flex-shrink-0 w-12 h-12 sm:w-14 sm:h-14 bg-brand-gold text-brand-black rounded-xl flex items-center justify-center hover:bg-brand-gold/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 sm:w-6 sm:h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5M5 12l7-7 7 7" />
          </svg>
        </button>
      </form>
    </div>

  </main>

  <script>
    // Chat API Configuration - Uses serverless API endpoint
    const CHAT_API_URL = '/api/chat';

    // LocalStorage keys
    const STORAGE_KEY = 'davidson_chat_history';
    const MESSAGES_KEY = 'davidson_chat_messages';

    // Chat history for context (system prompt is handled server-side)
    let chatHistory = [];

    // Load chat history from localStorage
    function loadChatHistory() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        const savedMessages = localStorage.getItem(MESSAGES_KEY);
        if (saved) {
          chatHistory = JSON.parse(saved);
        }
        if (savedMessages) {
          const messages = JSON.parse(savedMessages);
          // Restore messages to UI (skip welcome message restoration)
          messages.forEach(msg => {
            restoreMessage(msg.content, msg.isUser, msg.images || []);
          });
        }
      } catch (e) {
        console.error('Failed to load chat history:', e);
      }
    }

    // Save chat history to localStorage
    function saveChatHistory() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(chatHistory));
      } catch (e) {
        console.error('Failed to save chat history:', e);
      }
    }

    // Save displayed messages to localStorage
    let displayedMessages = [];
    function saveDisplayedMessages() {
      try {
        localStorage.setItem(MESSAGES_KEY, JSON.stringify(displayedMessages));
      } catch (e) {
        console.error('Failed to save messages:', e);
      }
    }

    // Clear chat history with blur poof animation
    function clearChatHistory() {
      chatHistory = [];
      displayedMessages = [];
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(MESSAGES_KEY);

      // Get all messages except the welcome message
      const messages = chatContainer.querySelectorAll('.message-appear, .flex.gap-3');
      const messagesToRemove = Array.from(messages).slice(1); // Skip first (welcome) message

      if (messagesToRemove.length === 0) return;

      // Apply vanish animation to each message with staggered delay
      messagesToRemove.forEach((msg, index) => {
        msg.style.animationDelay = `${index * 0.05}s`;
        msg.classList.add('message-vanish');
      });

      // Remove messages after animation completes
      const totalDuration = (messagesToRemove.length * 50) + 300;
      setTimeout(() => {
        messagesToRemove.forEach(msg => msg.remove());
      }, totalDuration);
    }
    window.clearChatHistory = clearChatHistory;

    // Restore message to UI (without animation, for page load)
    function restoreMessage(content, isUser = false, images = []) {
      const container = document.getElementById('chatContainer');
      if (!container) return;

      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex gap-3 sm:gap-4';

      if (isUser) {
        let imageThumbnails = '';
        if (images && images.length > 0) {
          imageThumbnails = `
            <div class="flex flex-wrap gap-2 mt-2">
              ${images.map(img => `
                <div class="w-12 h-12 rounded bg-brand-charcoal border border-brand-gold/30 flex items-center justify-center overflow-hidden">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-brand-gold/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                  </svg>
                </div>
              `).join('')}
            </div>
          `;
        }
        messageDiv.innerHTML = `
          <div class="flex-1 bg-brand-gold/10 rounded-2xl rounded-tr-none p-4 sm:p-5 border border-brand-gold/20 ml-8 sm:ml-12">
            <p class="text-sm sm:text-base text-gray-200 leading-relaxed whitespace-pre-wrap">${escapeHtml(content)}</p>
            ${imageThumbnails}
          </div>
          <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-brand-stone flex items-center justify-center border border-white/10">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
            </svg>
          </div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10">
            <img src="/secondary-logo.png" alt="Davidson" class="w-full h-full object-contain">
          </div>
          <div class="flex-1 bg-brand-charcoal rounded-2xl rounded-tl-none p-4 sm:p-5 border border-white/5 mr-8 sm:mr-12">
            <p class="text-sm sm:text-base text-gray-300 leading-relaxed whitespace-pre-wrap">${escapeHtml(content)}</p>
          </div>
        `;
      }

      container.appendChild(messageDiv);
    }

    // DOM Elements
    const chatContainer = document.getElementById('chatContainer');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const uploadButton = document.getElementById('uploadButton');
    const imageInput = document.getElementById('imageInput');
    const uploadPreview = document.getElementById('uploadPreview');

    // Track uploaded images
    let uploadedImages = [];

    // Upload button click handler
    uploadButton.addEventListener('click', () => {
      imageInput.click();
    });

    // Handle file selection
    imageInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      uploadButton.disabled = true;
      uploadButton.classList.add('opacity-50');

      for (const file of files) {
        await uploadImage(file);
      }

      uploadButton.disabled = false;
      uploadButton.classList.remove('opacity-50');
      imageInput.value = ''; // Reset input
    });

    // Upload a single image
    async function uploadImage(file) {
      // Show uploading preview
      const previewId = 'preview-' + Date.now();
      uploadPreview.classList.remove('hidden');
      uploadPreview.innerHTML += `
        <div id="${previewId}" class="relative">
          <div class="w-16 h-16 bg-brand-charcoal rounded-lg flex items-center justify-center border border-white/10">
            <svg class="w-6 h-6 text-brand-gold animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
          </div>
        </div>
      `;

      try {
        // Convert to base64
        const base64 = await fileToBase64(file);
        const base64Content = base64.split(',')[1]; // Remove data:image/... prefix

        // Upload to server
        const response = await fetch('/api/upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filename: file.name,
            content: base64Content,
            contentType: file.type
          })
        });

        const result = await response.json();

        if (result.success) {
          // Update preview with actual image
          const previewEl = document.getElementById(previewId);
          previewEl.innerHTML = `
            <div class="relative group">
              <img src="${base64}" class="w-16 h-16 object-cover rounded-lg border border-brand-gold/30">
              <button type="button" onclick="removeUpload('${previewId}', '${result.path}')"
                class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                ×
              </button>
              <div class="absolute bottom-0 left-0 right-0 bg-black/70 text-[8px] text-center text-brand-gold truncate px-1 rounded-b-lg">
                ${result.filename}
              </div>
            </div>
          `;
          uploadedImages.push({ path: result.path, filename: result.filename, previewId });
        } else {
          throw new Error(result.error || 'Upload failed');
        }
      } catch (error) {
        console.error('Upload error:', error);
        const previewEl = document.getElementById(previewId);
        previewEl.innerHTML = `
          <div class="w-16 h-16 bg-red-500/20 rounded-lg flex items-center justify-center border border-red-500/50">
            <span class="text-red-400 text-xs">Error</span>
          </div>
        `;
        setTimeout(() => previewEl.remove(), 2000);
      }
    }

    // Convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Remove uploaded image from preview
    function removeUpload(previewId, path) {
      document.getElementById(previewId)?.remove();
      uploadedImages = uploadedImages.filter(img => img.path !== path);
      if (uploadedImages.length === 0) {
        uploadPreview.classList.add('hidden');
      }
    }
    // Make removeUpload globally accessible
    window.removeUpload = removeUpload;

    // Blur fade-in letter animation function (word-aware to prevent splitting)
    function animateTextBlur(element, text, baseDelay = 0) {
      element.innerHTML = '';
      const words = text.split(' ');
      let charIndex = 0;
      const allCharSpans = [];

      words.forEach((word, wordIndex) => {
        // Create word wrapper to keep letters together
        const wordSpan = document.createElement('span');
        wordSpan.style.whiteSpace = 'nowrap';
        wordSpan.style.display = 'inline-block';

        // Add each character in the word
        word.split('').forEach((char) => {
          const charSpan = document.createElement('span');
          charSpan.className = 'blur-text-char';
          charSpan.textContent = char;
          charSpan.style.animationDelay = `${baseDelay + (charIndex * 15)}ms`;
          wordSpan.appendChild(charSpan);
          allCharSpans.push(charSpan);
          charIndex++;
        });

        element.appendChild(wordSpan);

        // Add space between words (except after last word)
        if (wordIndex < words.length - 1) {
          const spaceSpan = document.createElement('span');
          spaceSpan.className = 'blur-text-char space';
          spaceSpan.innerHTML = '&nbsp;';
          spaceSpan.style.animationDelay = `${baseDelay + (charIndex * 15)}ms`;
          element.appendChild(spaceSpan);
          allCharSpans.push(spaceSpan);
          charIndex++;
        }
      });

      // After all animations complete, add class to ensure no blur remains
      const totalAnimationTime = baseDelay + (charIndex * 15) + 500; // 500ms buffer after last char
      setTimeout(() => {
        allCharSpans.forEach(span => {
          span.classList.add('animation-complete');
        });
      }, totalAnimationTime);
    }

    // Animate welcome text on page load
    window.addEventListener('DOMContentLoaded', () => {
      const welcomeText = document.getElementById('welcomeText');
      if (welcomeText) {
        const text = welcomeText.getAttribute('data-text');
        animateTextBlur(welcomeText, text, 300);
      }
    });

    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Handle Enter key (Shift+Enter for new line)
    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
      }
    });

    // Add message to chat
    function addMessage(content, isUser = false, images = []) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message-appear flex gap-3 sm:gap-4';

      // Save message to displayed messages for localStorage
      displayedMessages.push({ content, isUser, images });
      saveDisplayedMessages();

      if (isUser) {
        // Build image thumbnails if any
        let imageThumbnails = '';
        if (images && images.length > 0) {
          imageThumbnails = `
            <div class="flex flex-wrap gap-2 mt-2">
              ${images.map(img => `
                <div class="w-12 h-12 rounded bg-brand-charcoal border border-brand-gold/30 flex items-center justify-center overflow-hidden">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-brand-gold/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                  </svg>
                </div>
              `).join('')}
            </div>
          `;
        }

        messageDiv.innerHTML = `
          <div class="flex-1 bg-brand-gold/10 rounded-2xl rounded-tr-none p-4 sm:p-5 border border-brand-gold/20 ml-8 sm:ml-12">
            <p class="text-sm sm:text-base text-gray-200 leading-relaxed whitespace-pre-wrap">${escapeHtml(content)}</p>
            ${imageThumbnails}
          </div>
          <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-brand-stone flex items-center justify-center border border-white/10">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
            </svg>
          </div>
        `;
      } else {
        // Create message structure for bot response
        const msgId = 'botMsg_' + Date.now();
        messageDiv.innerHTML = `
          <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10">
            <img src="/secondary-logo.png" alt="Davidson" class="w-full h-full object-contain">
          </div>
          <div class="flex-1 bg-brand-charcoal rounded-2xl rounded-tl-none p-4 sm:p-5 border border-white/5 mr-8 sm:mr-12">
            <p id="${msgId}" class="text-sm sm:text-base text-gray-300 leading-relaxed whitespace-pre-wrap blur-text-container"></p>
          </div>
        `;
        chatContainer.appendChild(messageDiv);

        // Apply blur animation to bot response
        const textElement = document.getElementById(msgId);
        animateTextBlur(textElement, content, 0);
        scrollToBottom();
        return;
      }

      chatContainer.appendChild(messageDiv);
      scrollToBottom();
    }

    // Generate contextual thinking messages based on user input
    function getContextualThinkingMessages(userMessage) {
      const msg = userMessage.toLowerCase();

      // Competitor/research related
      if (msg.includes('competitor') || msg.includes('competition') || msg.includes('rival')) {
        return [
          "Analysing competitors...",
          "Accessing competitor information...",
          "Researching market positioning...",
          "Applying competitive analysis...",
          "Identifying key differentiators...",
          "Reviewing industry standards...",
          "Compiling insights...",
          "Finalising analysis..."
        ];
      }

      // Brainstorm/idea related
      if (msg.includes('brainstorm') || msg.includes('idea') || msg.includes('suggest') || msg.includes('recommend')) {
        return [
          "Generating creative ideas...",
          "Exploring possibilities...",
          "Thinking through options...",
          "Considering different angles...",
          "Refining the concepts...",
          "Evaluating best approaches...",
          "Curating recommendations...",
          "Preparing suggestions..."
        ];
      }

      // Page creation related
      if (msg.includes('page') || msg.includes('section') || msg.includes('create') || msg.includes('add') || msg.includes('build')) {
        return [
          "Planning the structure...",
          "Designing the layout...",
          "Ensuring visual consistency...",
          "Keeping the elegance intact...",
          "Building your content...",
          "Checking for potential issues...",
          "Optimising for all devices...",
          "Adding finishing touches..."
        ];
      }

      // Design/style related
      if (msg.includes('design') || msg.includes('style') || msg.includes('look') || msg.includes('colour') || msg.includes('color') || msg.includes('font')) {
        return [
          "Analysing current design...",
          "Exploring style options...",
          "Balancing aesthetics...",
          "Ensuring brand consistency...",
          "Refining visual elements...",
          "Harmonising the palette...",
          "Perfecting the details...",
          "Making it beautiful..."
        ];
      }

      // Fix/bug related
      if (msg.includes('fix') || msg.includes('bug') || msg.includes('error') || msg.includes('broken') || msg.includes('wrong') || msg.includes('issue')) {
        return [
          "Investigating the issue...",
          "Tracing the problem...",
          "Analysing the code...",
          "Identifying the root cause...",
          "Developing a solution...",
          "Testing the fix...",
          "Verifying everything works...",
          "Ensuring stability..."
        ];
      }

      // Content/text related
      if (msg.includes('text') || msg.includes('content') || msg.includes('copy') || msg.includes('write') || msg.includes('word')) {
        return [
          "Crafting the message...",
          "Refining the language...",
          "Ensuring clarity...",
          "Matching the brand voice...",
          "Polishing the copy...",
          "Reviewing readability...",
          "Adding the right tone...",
          "Perfecting the words..."
        ];
      }

      // Image related
      if (msg.includes('image') || msg.includes('photo') || msg.includes('picture') || msg.includes('logo') || msg.includes('upload')) {
        return [
          "Processing your image...",
          "Optimising placement...",
          "Ensuring visual balance...",
          "Integrating seamlessly...",
          "Checking responsiveness...",
          "Aligning with design...",
          "Fine-tuning display...",
          "Making it look great..."
        ];
      }

      // Web browsing related
      if (msg.includes('browse') || msg.includes('look at') || msg.includes('check out') || msg.includes('website') || msg.includes('url') || msg.includes('http')) {
        return [
          "Accessing the website...",
          "Gathering information...",
          "Analysing the content...",
          "Extracting key details...",
          "Processing the data...",
          "Compiling findings...",
          "Reviewing insights...",
          "Preparing summary..."
        ];
      }

      // Default messages
      return [
        "Reading your request...",
        "Understanding what you need...",
        "Looking at the website...",
        "Planning the approach...",
        "Working on your request...",
        "Building your content...",
        "Adding finishing touches...",
        "Almost there..."
      ];
    }

    // Current thinking messages (set dynamically)
    let currentThinkingMessages = [];

    // Publishing status messages
    const publishingMessages = [
      "Preparing your changes...",
      "Sending to the server...",
      "Building the website...",
      "Optimizing for speed...",
      "Running final checks...",
      "Almost live...",
      "Just a few more seconds..."
    ];

    let thinkingInterval = null;
    let timerInterval = null;
    let startTime = null;
    let currentAbortController = null;

    // Format elapsed time as minutes and seconds (e.g., "1m30s" or "45s")
    function formatElapsedTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = (seconds % 60).toFixed(0);
      if (mins > 0) {
        return `${mins}m${secs.padStart(2, '0')}s`;
      }
      return `${seconds.toFixed(1)}s`;
    }

    // Stop the current generation
    function stopGeneration() {
      if (currentAbortController) {
        currentAbortController.abort();
        currentAbortController = null;
      }
    }

    // Add typing indicator with timer and thinking status
    function addTypingIndicator(userMessage = '') {
      startTime = Date.now();
      let messageIndex = 0;

      // Get contextual messages based on user input
      currentThinkingMessages = getContextualThinkingMessages(userMessage);

      const typingDiv = document.createElement('div');
      typingDiv.id = 'typingIndicator';
      typingDiv.className = 'message-appear flex gap-3 sm:gap-4 items-center justify-center py-8';
      typingDiv.innerHTML = `
        <div class="flex flex-col items-center gap-4">
          <img src="/secondary-logo.png" alt="Loading..." class="typing-logo w-16 h-16 sm:w-20 sm:h-20">
          <div class="flex flex-col items-center gap-2">
            <span id="thinkingStatus" class="text-xs sm:text-sm text-gray-400 transition-opacity duration-300">${currentThinkingMessages[0]}</span>
            <span id="thinkingTimer" class="text-[10px] tracking-[0.2em] text-brand-gold/60 font-mono">0.0s</span>
          </div>
          <button id="stopButton" class="mt-2 px-4 py-2 bg-red-500/20 hover:bg-red-500/40 text-red-400 hover:text-red-300 text-xs font-medium rounded-lg transition-all duration-200 flex items-center gap-2 border border-red-500/30 hover:border-red-500/50">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
              <rect x="6" y="6" width="12" height="12" rx="1" />
            </svg>
            Stop
          </button>
        </div>
      `;
      chatContainer.appendChild(typingDiv);
      scrollToBottom();

      // Add stop button event listener
      const stopBtn = document.getElementById('stopButton');
      if (stopBtn) {
        stopBtn.addEventListener('click', stopGeneration);
      }

      // Update timer every 100ms
      timerInterval = setInterval(() => {
        const elapsed = (Date.now() - startTime) / 1000;
        const timerEl = document.getElementById('thinkingTimer');
        if (timerEl) timerEl.textContent = formatElapsedTime(elapsed);
      }, 100);

      // Cycle through thinking messages every 2.5 seconds
      thinkingInterval = setInterval(() => {
        messageIndex = (messageIndex + 1) % currentThinkingMessages.length;
        const statusEl = document.getElementById('thinkingStatus');
        if (statusEl) {
          statusEl.style.opacity = '0';
          setTimeout(() => {
            statusEl.textContent = currentThinkingMessages[messageIndex];
            statusEl.style.opacity = '1';
          }, 150);
        }
      }, 2500);
    }

    // Remove typing indicator and clear intervals
    function removeTypingIndicator() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      if (thinkingInterval) {
        clearInterval(thinkingInterval);
        thinkingInterval = null;
      }
      const typing = document.getElementById('typingIndicator');
      if (typing) typing.remove();
    }

    // Scroll to bottom of chat
    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Format response (basic markdown-like formatting)
    function formatResponse(text) {
      return escapeHtml(text)
        .replace(/\*\*(.*?)\*\*/g, '<strong class="text-brand-white">$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code class="bg-brand-stone px-1 rounded text-brand-gold">$1</code>');
    }

    // Send message to serverless API
    async function sendMessage(message, signal) {
      chatHistory.push({ role: 'user', content: message });
      saveChatHistory(); // Save to localStorage

      try {
        const response = await fetch(CHAT_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            messages: chatHistory
          }),
          signal: signal
        });

        // Get response text first for better error handling
        const responseText = await response.text();

        let data;
        try {
          data = JSON.parse(responseText);
        } catch (jsonError) {
          console.error('JSON parse error:', jsonError);
          console.error('Response text (first 500 chars):', responseText.substring(0, 500));
          throw new Error('Invalid response from server. Please try again.');
        }

        if (!response.ok) {
          console.error('API error:', data);
          // Use server's user-friendly message if available
          throw new Error(data.message || data.error || 'API request failed');
        }

        const assistantMessage = data.message;
        chatHistory.push({ role: 'assistant', content: assistantMessage });
        saveChatHistory(); // Save to localStorage
        return { message: assistantMessage, madeChanges: data.madeChanges || false, stopped: false };

      } catch (error) {
        console.error('Chat error:', error);
        chatHistory.pop(); // Remove the user message we added

        // Check if request was aborted
        if (error.name === 'AbortError') {
          return { message: null, madeChanges: false, stopped: true };
        }

        // Use the error message from server if available, otherwise show generic message
        const errorMessage = error.message && error.message !== 'API request failed'
          ? error.message
          : 'I encountered an issue. Please try again.';
        return { message: errorMessage, madeChanges: false, stopped: false };
      }
    }

    // Show delete confirmation button
    let pendingDeletePath = null;
    let pendingDeleteName = null;

    function showDeleteButton(path, displayName) {
      pendingDeletePath = path;
      pendingDeleteName = displayName;

      const deleteDiv = document.createElement('div');
      deleteDiv.id = 'deleteConfirm';
      deleteDiv.className = 'message-appear flex gap-3 sm:gap-4 items-center justify-center py-6';
      deleteDiv.innerHTML = `
        <div class="flex flex-col items-center gap-4 p-6 bg-brand-charcoal rounded-2xl border border-red-500/30">
          <p class="text-sm text-gray-300 text-center">Are you sure you want to delete <span class="text-red-400 font-medium">${displayName}</span>?</p>
          <div class="flex gap-3">
            <button id="cancelDeleteBtn" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-xl transition-colors">
              Cancel
            </button>
            <button id="confirmDeleteBtn" class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-medium rounded-xl transition-colors flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
              Confirm Delete
            </button>
          </div>
        </div>
      `;
      chatContainer.appendChild(deleteDiv);
      scrollToBottom();

      // Add click handlers
      document.getElementById('confirmDeleteBtn').addEventListener('click', startDeleting);
      document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
        const deleteConfirm = document.getElementById('deleteConfirm');
        if (deleteConfirm) deleteConfirm.remove();
        pendingDeletePath = null;
        pendingDeleteName = null;
      });
    }

    // Start the deletion process
    async function startDeleting() {
      // Remove delete button
      const deleteConfirm = document.getElementById('deleteConfirm');
      if (deleteConfirm) deleteConfirm.remove();

      if (!pendingDeletePath) {
        addMessage('Error: No file selected for deletion.', false);
        return;
      }

      // Show deleting indicator
      const deletingDiv = document.createElement('div');
      deletingDiv.id = 'deletingIndicator';
      deletingDiv.className = 'message-appear flex gap-3 sm:gap-4 items-center justify-center py-8';
      deletingDiv.innerHTML = `
        <div class="flex flex-col items-center gap-4">
          <img src="/secondary-logo.png" alt="Deleting..." class="typing-logo w-16 h-16 sm:w-20 sm:h-20">
          <div class="flex flex-col items-center gap-2">
            <span class="text-sm font-medium text-red-400">Deleting ${pendingDeleteName}...</span>
            <span class="text-xs text-gray-400">Please wait</span>
          </div>
        </div>
      `;
      chatContainer.appendChild(deletingDiv);
      scrollToBottom();

      try {
        const response = await fetch('/api/delete-file', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: pendingDeletePath })
        });

        const result = await response.json();

        // Remove deleting indicator
        const indicator = document.getElementById('deletingIndicator');
        if (indicator) indicator.remove();

        if (result.success) {
          // Show success message
          addMessage(`Successfully deleted ${pendingDeleteName}. The page will no longer be accessible.`, false);
        } else {
          throw new Error(result.error || 'Failed to delete file');
        }
      } catch (error) {
        console.error('Delete error:', error);

        // Remove deleting indicator
        const indicator = document.getElementById('deletingIndicator');
        if (indicator) indicator.remove();

        addMessage(`Failed to delete ${pendingDeleteName}. ${error.message || 'Please try again.'}`, false);
      } finally {
        pendingDeletePath = null;
        pendingDeleteName = null;
      }
    }

    // Show publish confirmation button
    function showPublishButton() {
      const publishDiv = document.createElement('div');
      publishDiv.id = 'publishConfirm';
      publishDiv.className = 'message-appear flex gap-3 sm:gap-4 items-center justify-center py-6';
      publishDiv.innerHTML = `
        <div class="flex flex-col items-center gap-4 p-6 bg-brand-charcoal rounded-2xl border border-green-500/30">
          <p class="text-sm text-gray-300 text-center">Your changes are ready. Would you like to publish them to the live website?</p>
          <button id="publishBtn" class="publish-btn px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-medium rounded-xl transition-colors flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
            Confirm & Publish
          </button>
        </div>
      `;
      chatContainer.appendChild(publishDiv);
      scrollToBottom();

      // Add click handler
      document.getElementById('publishBtn').addEventListener('click', startPublishing);
    }

    // Publishing indicator variables
    let publishingInterval = null;
    let publishTimerInterval = null;
    let publishStartTime = null;

    // Start the publishing process
    async function startPublishing() {
      // Remove publish button
      const publishConfirm = document.getElementById('publishConfirm');
      if (publishConfirm) publishConfirm.remove();

      // Show publishing indicator
      publishStartTime = Date.now();
      let messageIndex = 0;

      const publishingDiv = document.createElement('div');
      publishingDiv.id = 'publishingIndicator';
      publishingDiv.className = 'message-appear flex gap-3 sm:gap-4 items-center justify-center py-8';
      publishingDiv.innerHTML = `
        <div class="flex flex-col items-center gap-4">
          <img src="/secondary-logo.png" alt="Publishing..." class="typing-logo w-16 h-16 sm:w-20 sm:h-20">
          <div class="flex flex-col items-center gap-2">
            <span class="text-sm font-medium text-green-400">Publishing Please Wait</span>
            <span id="publishingStatus" class="text-xs sm:text-sm text-gray-400 transition-opacity duration-300">${publishingMessages[0]}</span>
            <span id="publishingTimer" class="text-[10px] tracking-[0.2em] text-brand-gold/60 font-mono">0.0s</span>
          </div>
        </div>
      `;
      chatContainer.appendChild(publishingDiv);
      scrollToBottom();

      // Update timer every 100ms
      publishTimerInterval = setInterval(() => {
        const elapsed = (Date.now() - publishStartTime) / 1000;
        const timerEl = document.getElementById('publishingTimer');
        if (timerEl) timerEl.textContent = formatElapsedTime(elapsed);
      }, 100);

      // Cycle through publishing messages every 2 seconds
      publishingInterval = setInterval(() => {
        messageIndex = (messageIndex + 1) % publishingMessages.length;
        const statusEl = document.getElementById('publishingStatus');
        if (statusEl) {
          statusEl.style.opacity = '0';
          setTimeout(() => {
            statusEl.textContent = publishingMessages[messageIndex];
            statusEl.style.opacity = '1';
          }, 150);
        }
      }, 2000);

      // Poll for deployment status
      await checkDeploymentStatus();
    }

    // Check Vercel deployment status
    async function checkDeploymentStatus() {
      const maxAttempts = 60; // Max 2 minutes (2s intervals)
      let attempts = 0;

      const checkStatus = async () => {
        try {
          const response = await fetch('/api/deployment-status');
          const data = await response.json();

          if (data.status === 'ready' || attempts >= maxAttempts) {
            // Deployment complete - show success
            clearPublishingIndicator();
            showSuccessAnimation();
          } else if (data.status === 'error') {
            clearPublishingIndicator();
            showErrorMessage();
          } else {
            // Still building - check again in 2 seconds
            attempts++;
            setTimeout(checkStatus, 2000);
          }
        } catch (error) {
          // On error, assume success after a delay
          console.error('Status check error:', error);
          if (attempts >= 5) {
            clearPublishingIndicator();
            showSuccessAnimation();
          } else {
            attempts++;
            setTimeout(checkStatus, 2000);
          }
        }
      };

      // Start checking after initial delay (give Vercel time to start)
      setTimeout(checkStatus, 3000);
    }

    // Clear publishing indicator
    function clearPublishingIndicator() {
      if (publishTimerInterval) {
        clearInterval(publishTimerInterval);
        publishTimerInterval = null;
      }
      if (publishingInterval) {
        clearInterval(publishingInterval);
        publishingInterval = null;
      }
      const indicator = document.getElementById('publishingIndicator');
      if (indicator) indicator.remove();
    }

    // Show success animation
    function showSuccessAnimation() {
      // Calculate publishing duration
      const publishDuration = publishStartTime ? ((Date.now() - publishStartTime) / 1000).toFixed(1) : '0.0';

      const successDiv = document.createElement('div');
      successDiv.id = 'successMessage';
      successDiv.className = 'message-appear flex gap-3 sm:gap-4 items-center justify-center py-8';
      successDiv.innerHTML = `
        <div class="flex flex-col items-center gap-6 p-8 bg-brand-charcoal rounded-2xl border border-green-500/30">
          <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="success-checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="success-checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
          </svg>
          <div class="text-center">
            <h3 class="text-xl font-serif text-green-400 mb-2">Congratulations!</h3>
            <p class="text-sm text-gray-300 mb-2">Your changes have been published successfully.</p>
            <p class="text-xs text-brand-gold/80 mb-4">Published in ${publishDuration} seconds</p>
            <p class="text-xs text-gray-400 mb-4">Refresh your main website to see the changes.</p>
            <p class="text-xs text-brand-gold">Feel free to return if you want further changes.</p>
          </div>
          <a href="/" target="_blank" class="px-4 py-2 bg-brand-gold/20 hover:bg-brand-gold/30 text-brand-gold text-sm rounded-lg transition-colors">
            View Website →
          </a>
        </div>
      `;
      chatContainer.appendChild(successDiv);
      scrollToBottom();
    }

    // Show error message
    function showErrorMessage() {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'message-appear flex gap-3 sm:gap-4 items-center justify-center py-6';
      errorDiv.innerHTML = `
        <div class="flex flex-col items-center gap-4 p-6 bg-brand-charcoal rounded-2xl border border-red-500/30">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <p class="text-sm text-gray-300 text-center">There was an issue publishing. Please try again or contact support.</p>
        </div>
      `;
      chatContainer.appendChild(errorDiv);
      scrollToBottom();
    }

    // Handle form submission
    chatForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      let message = messageInput.value.trim();
      if (!message && uploadedImages.length === 0) return;

      // Remove any existing publish/success elements
      document.getElementById('publishConfirm')?.remove();
      document.getElementById('successMessage')?.remove();

      // Append uploaded image info to message
      if (uploadedImages.length > 0) {
        const imageInfo = uploadedImages.map(img => `[Uploaded image: ${img.path}]`).join('\n');
        message = message ? `${message}\n\n${imageInfo}` : imageInfo;
      }

      // Disable input while processing
      messageInput.disabled = true;
      sendButton.disabled = true;
      uploadButton.disabled = true;

      // Add user message (show original text without image paths for cleaner UI)
      const displayMessage = messageInput.value.trim() || 'Uploaded images';
      addMessage(displayMessage, true, uploadedImages);

      // Clear input and uploads
      messageInput.value = '';
      messageInput.style.height = 'auto';
      uploadedImages = [];
      uploadPreview.innerHTML = '';
      uploadPreview.classList.add('hidden');

      // Create abort controller for this request
      currentAbortController = new AbortController();

      // Show typing indicator with contextual messages
      addTypingIndicator(displayMessage);

      // Get AI response
      const result = await sendMessage(message, currentAbortController.signal);

      // Remove typing indicator
      removeTypingIndicator();
      currentAbortController = null;

      // Handle stopped vs completed
      if (result.stopped) {
        addMessage('Request stopped.', false);
      } else {
        addMessage(result.message, false);
      }

      // If deletion is requested, show the delete button
      if (result.requestsDelete && !result.stopped) {
        showDeleteButton(result.requestsDelete.path, result.requestsDelete.displayName);
      }

      // If changes were made, show the publish button
      if (result.madeChanges && !result.stopped) {
        showPublishButton();
      }

      // Re-enable input
      messageInput.disabled = false;
      sendButton.disabled = false;
      uploadButton.disabled = false;
      messageInput.focus();
    });

    // Focus input on load and restore chat history
    window.addEventListener('load', () => {
      loadChatHistory();
      messageInput.focus();
      scrollToBottom();
    });
  </script>

</body>

</html>
