<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Davidson & Co. London | AI Builder</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;700&family=Manrope:wght@200;300;400;500&display=swap"
    rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              black: '#080808',
              charcoal: '#121212',
              gold: '#D4AF37',
              goldDim: '#8A7120',
              stone: '#1c1c1c',
              white: '#F5F5F5'
            }
          },
          fontFamily: {
            serif: ['Cinzel', 'serif'],
            sans: ['Manrope', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    html, body {
      height: 100%;
    }

    body {
      background-color: #080808;
      color: #F5F5F5;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #121212;
    }

    ::-webkit-scrollbar-thumb {
      background: #D4AF37;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #8A7120;
    }

    .chat-container {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .message-appear {
      animation: fadeInUp 0.3s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Logo blur pulse animation for typing indicator */
    .typing-logo {
      animation: blurPulse 2s ease-in-out infinite;
    }

    @keyframes blurPulse {
      0%, 100% {
        opacity: 0.3;
        filter: blur(6px);
        transform: scale(0.95);
      }
      50% {
        opacity: 1;
        filter: blur(0);
        transform: scale(1);
      }
    }

    .grain-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
    }

    /* Blur fade-in letter animation */
    .blur-text-char {
      display: inline-block;
      opacity: 0;
      filter: blur(8px);
      animation: blurFadeIn 0.4s ease-out forwards;
    }

    .blur-text-char.space {
      width: 0.25em;
    }

    @keyframes blurFadeIn {
      0% {
        opacity: 0;
        filter: blur(8px);
        transform: translateY(5px);
      }
      100% {
        opacity: 1;
        filter: blur(0);
        transform: translateY(0);
      }
    }
  </style>
</head>

<body class="relative font-sans">

  <!-- Cinematic Grain Overlay -->
  <div class="grain-overlay"></div>

  <!-- Header -->
  <header class="fixed top-0 left-0 right-0 z-40 bg-brand-black/90 backdrop-blur-sm border-b border-white/5">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-3">
        <img src="/logo.png" alt="Davidson & Co." class="h-8 sm:h-10">
      </a>
    </div>
  </header>

  <!-- Main Chat Interface -->
  <main class="pt-20 pb-4 px-4 sm:px-6 flex flex-col max-w-5xl mx-auto" style="height: 100%; height: 100dvh;">

    <!-- Chat Messages Container -->
    <div id="chatContainer" class="chat-container overflow-y-auto flex flex-col gap-4 py-6">

      <!-- Welcome Message -->
      <div class="message-appear flex gap-3 sm:gap-4">
        <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10">
          <img src="/secondary-logo.png" alt="Davidson" class="w-full h-full object-contain">
        </div>
        <div class="flex-1 bg-brand-charcoal rounded-2xl rounded-tl-none p-4 sm:p-5 border border-white/5">
          <p id="welcomeText" class="text-sm sm:text-base text-gray-300 leading-relaxed blur-text-container" data-text="Welcome to the Davidson & Co. London website development assistant. What would you like me to help you build today?"></p>
        </div>
      </div>

    </div>

    <!-- Input Area -->
    <div class="flex-shrink-0 pt-4 border-t border-white/5">
      <!-- Upload Preview Area -->
      <div id="uploadPreview" class="hidden mb-3 flex flex-wrap gap-2">
      </div>
      <form id="chatForm" class="flex gap-2 sm:gap-3 items-center">
        <!-- Hidden file input -->
        <input type="file" id="imageInput" accept="image/*" multiple class="hidden">
        <!-- Upload button -->
        <button
          type="button"
          id="uploadButton"
          class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 bg-brand-charcoal border border-white/10 text-gray-400 rounded-xl flex items-center justify-center hover:border-brand-gold/50 hover:text-brand-gold transition-colors"
          title="Upload images"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 sm:w-6 sm:h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
          </svg>
        </button>
        <div class="flex-1 relative">
          <textarea
            id="messageInput"
            rows="1"
            placeholder="Type your message..."
            class="w-full bg-brand-charcoal border border-white/10 rounded-xl px-4 py-3 sm:py-4 text-base text-brand-white placeholder-gray-500 outline-none focus:border-brand-gold/50 transition-colors resize-none overflow-hidden"
            style="max-height: 120px;"
          ></textarea>
        </div>
        <button
          type="submit"
          id="sendButton"
          class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 bg-brand-gold text-brand-black rounded-xl flex items-center justify-center hover:bg-brand-gold/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 sm:w-6 sm:h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5M5 12l7-7 7 7" />
          </svg>
        </button>
      </form>
    </div>

  </main>

  <script>
    // Chat API Configuration - Uses serverless API endpoint
    const CHAT_API_URL = '/api/chat';

    // Chat history for context (system prompt is handled server-side)
    let chatHistory = [];

    // DOM Elements
    const chatContainer = document.getElementById('chatContainer');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const uploadButton = document.getElementById('uploadButton');
    const imageInput = document.getElementById('imageInput');
    const uploadPreview = document.getElementById('uploadPreview');

    // Track uploaded images
    let uploadedImages = [];

    // Upload button click handler
    uploadButton.addEventListener('click', () => {
      imageInput.click();
    });

    // Handle file selection
    imageInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      uploadButton.disabled = true;
      uploadButton.classList.add('opacity-50');

      for (const file of files) {
        await uploadImage(file);
      }

      uploadButton.disabled = false;
      uploadButton.classList.remove('opacity-50');
      imageInput.value = ''; // Reset input
    });

    // Upload a single image
    async function uploadImage(file) {
      // Show uploading preview
      const previewId = 'preview-' + Date.now();
      uploadPreview.classList.remove('hidden');
      uploadPreview.innerHTML += `
        <div id="${previewId}" class="relative">
          <div class="w-16 h-16 bg-brand-charcoal rounded-lg flex items-center justify-center border border-white/10">
            <svg class="w-6 h-6 text-brand-gold animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
            </svg>
          </div>
        </div>
      `;

      try {
        // Convert to base64
        const base64 = await fileToBase64(file);
        const base64Content = base64.split(',')[1]; // Remove data:image/... prefix

        // Upload to server
        const response = await fetch('/api/upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            filename: file.name,
            content: base64Content,
            contentType: file.type
          })
        });

        const result = await response.json();

        if (result.success) {
          // Update preview with actual image
          const previewEl = document.getElementById(previewId);
          previewEl.innerHTML = `
            <div class="relative group">
              <img src="${base64}" class="w-16 h-16 object-cover rounded-lg border border-brand-gold/30">
              <button type="button" onclick="removeUpload('${previewId}', '${result.path}')"
                class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                Ã—
              </button>
              <div class="absolute bottom-0 left-0 right-0 bg-black/70 text-[8px] text-center text-brand-gold truncate px-1 rounded-b-lg">
                ${result.filename}
              </div>
            </div>
          `;
          uploadedImages.push({ path: result.path, filename: result.filename, previewId });
        } else {
          throw new Error(result.error || 'Upload failed');
        }
      } catch (error) {
        console.error('Upload error:', error);
        const previewEl = document.getElementById(previewId);
        previewEl.innerHTML = `
          <div class="w-16 h-16 bg-red-500/20 rounded-lg flex items-center justify-center border border-red-500/50">
            <span class="text-red-400 text-xs">Error</span>
          </div>
        `;
        setTimeout(() => previewEl.remove(), 2000);
      }
    }

    // Convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Remove uploaded image from preview
    function removeUpload(previewId, path) {
      document.getElementById(previewId)?.remove();
      uploadedImages = uploadedImages.filter(img => img.path !== path);
      if (uploadedImages.length === 0) {
        uploadPreview.classList.add('hidden');
      }
    }
    // Make removeUpload globally accessible
    window.removeUpload = removeUpload;

    // Blur fade-in letter animation function (word-aware to prevent splitting)
    function animateTextBlur(element, text, baseDelay = 0) {
      element.innerHTML = '';
      const words = text.split(' ');
      let charIndex = 0;

      words.forEach((word, wordIndex) => {
        // Create word wrapper to keep letters together
        const wordSpan = document.createElement('span');
        wordSpan.style.whiteSpace = 'nowrap';
        wordSpan.style.display = 'inline-block';

        // Add each character in the word
        word.split('').forEach((char) => {
          const charSpan = document.createElement('span');
          charSpan.className = 'blur-text-char';
          charSpan.textContent = char;
          charSpan.style.animationDelay = `${baseDelay + (charIndex * 15)}ms`;
          wordSpan.appendChild(charSpan);
          charIndex++;
        });

        element.appendChild(wordSpan);

        // Add space between words (except after last word)
        if (wordIndex < words.length - 1) {
          const spaceSpan = document.createElement('span');
          spaceSpan.className = 'blur-text-char space';
          spaceSpan.innerHTML = '&nbsp;';
          spaceSpan.style.animationDelay = `${baseDelay + (charIndex * 15)}ms`;
          element.appendChild(spaceSpan);
          charIndex++;
        }
      });
    }

    // Animate welcome text on page load
    window.addEventListener('DOMContentLoaded', () => {
      const welcomeText = document.getElementById('welcomeText');
      if (welcomeText) {
        const text = welcomeText.getAttribute('data-text');
        animateTextBlur(welcomeText, text, 300);
      }
    });

    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Handle Enter key (Shift+Enter for new line)
    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
      }
    });

    // Add message to chat
    function addMessage(content, isUser = false, images = []) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message-appear flex gap-3 sm:gap-4';

      if (isUser) {
        // Build image thumbnails if any
        let imageThumbnails = '';
        if (images && images.length > 0) {
          imageThumbnails = `
            <div class="flex flex-wrap gap-2 mt-2">
              ${images.map(img => `
                <div class="w-12 h-12 rounded bg-brand-charcoal border border-brand-gold/30 flex items-center justify-center overflow-hidden">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-brand-gold/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                  </svg>
                </div>
              `).join('')}
            </div>
          `;
        }

        messageDiv.innerHTML = `
          <div class="flex-1 bg-brand-gold/10 rounded-2xl rounded-tr-none p-4 sm:p-5 border border-brand-gold/20 ml-8 sm:ml-12">
            <p class="text-sm sm:text-base text-gray-200 leading-relaxed whitespace-pre-wrap">${escapeHtml(content)}</p>
            ${imageThumbnails}
          </div>
          <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-brand-stone flex items-center justify-center border border-white/10">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
            </svg>
          </div>
        `;
      } else {
        // Create message structure for bot response
        const msgId = 'botMsg_' + Date.now();
        messageDiv.innerHTML = `
          <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10">
            <img src="/secondary-logo.png" alt="Davidson" class="w-full h-full object-contain">
          </div>
          <div class="flex-1 bg-brand-charcoal rounded-2xl rounded-tl-none p-4 sm:p-5 border border-white/5 mr-8 sm:mr-12">
            <p id="${msgId}" class="text-sm sm:text-base text-gray-300 leading-relaxed whitespace-pre-wrap blur-text-container"></p>
          </div>
        `;
        chatContainer.appendChild(messageDiv);

        // Apply blur animation to bot response
        const textElement = document.getElementById(msgId);
        animateTextBlur(textElement, content, 0);
        scrollToBottom();
        return;
      }

      chatContainer.appendChild(messageDiv);
      scrollToBottom();
    }

    // Thinking status messages (non-technical, friendly)
    const thinkingMessages = [
      "Reading your request...",
      "Understanding what you need...",
      "Looking at the website...",
      "Planning the changes...",
      "Working on your request...",
      "Building your content...",
      "Adding the finishing touches...",
      "Almost there...",
      "Making it perfect...",
      "Just a moment more..."
    ];

    let thinkingInterval = null;
    let timerInterval = null;
    let startTime = null;

    // Add typing indicator with timer and thinking status
    function addTypingIndicator() {
      startTime = Date.now();
      let messageIndex = 0;

      const typingDiv = document.createElement('div');
      typingDiv.id = 'typingIndicator';
      typingDiv.className = 'message-appear flex gap-3 sm:gap-4 items-center justify-center py-8';
      typingDiv.innerHTML = `
        <div class="flex flex-col items-center gap-4">
          <img src="/secondary-logo.png" alt="Loading..." class="typing-logo w-16 h-16 sm:w-20 sm:h-20">
          <div class="flex flex-col items-center gap-2">
            <span id="thinkingStatus" class="text-xs sm:text-sm text-gray-400 transition-opacity duration-300">${thinkingMessages[0]}</span>
            <span id="thinkingTimer" class="text-[10px] tracking-[0.2em] text-brand-gold/60 font-mono">0.0s</span>
          </div>
        </div>
      `;
      chatContainer.appendChild(typingDiv);
      scrollToBottom();

      // Update timer every 100ms
      timerInterval = setInterval(() => {
        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
        const timerEl = document.getElementById('thinkingTimer');
        if (timerEl) timerEl.textContent = `${elapsed}s`;
      }, 100);

      // Cycle through thinking messages every 2.5 seconds
      thinkingInterval = setInterval(() => {
        messageIndex = (messageIndex + 1) % thinkingMessages.length;
        const statusEl = document.getElementById('thinkingStatus');
        if (statusEl) {
          statusEl.style.opacity = '0';
          setTimeout(() => {
            statusEl.textContent = thinkingMessages[messageIndex];
            statusEl.style.opacity = '1';
          }, 150);
        }
      }, 2500);
    }

    // Remove typing indicator and clear intervals
    function removeTypingIndicator() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      if (thinkingInterval) {
        clearInterval(thinkingInterval);
        thinkingInterval = null;
      }
      const typing = document.getElementById('typingIndicator');
      if (typing) typing.remove();
    }

    // Scroll to bottom of chat
    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Format response (basic markdown-like formatting)
    function formatResponse(text) {
      return escapeHtml(text)
        .replace(/\*\*(.*?)\*\*/g, '<strong class="text-brand-white">$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code class="bg-brand-stone px-1 rounded text-brand-gold">$1</code>');
    }

    // Send message to serverless API
    async function sendMessage(message) {
      chatHistory.push({ role: 'user', content: message });

      try {
        const response = await fetch(CHAT_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            messages: chatHistory
          })
        });

        const data = await response.json();

        if (!response.ok) {
          console.error('API error:', data);
          throw new Error(data.error || 'API request failed');
        }

        const assistantMessage = data.message;
        chatHistory.push({ role: 'assistant', content: assistantMessage });
        return assistantMessage;

      } catch (error) {
        console.error('Chat error:', error);
        chatHistory.pop(); // Remove the user message we added
        return 'I apologize, but I encountered an issue connecting to the AI service. Please try again or contact support if the problem persists.';
      }
    }

    // Handle form submission
    chatForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      let message = messageInput.value.trim();
      if (!message && uploadedImages.length === 0) return;

      // Append uploaded image info to message
      if (uploadedImages.length > 0) {
        const imageInfo = uploadedImages.map(img => `[Uploaded image: ${img.path}]`).join('\n');
        message = message ? `${message}\n\n${imageInfo}` : imageInfo;
      }

      // Disable input while processing
      messageInput.disabled = true;
      sendButton.disabled = true;
      uploadButton.disabled = true;

      // Add user message (show original text without image paths for cleaner UI)
      const displayMessage = messageInput.value.trim() || 'Uploaded images';
      addMessage(displayMessage, true, uploadedImages);

      // Clear input and uploads
      messageInput.value = '';
      messageInput.style.height = 'auto';
      uploadedImages = [];
      uploadPreview.innerHTML = '';
      uploadPreview.classList.add('hidden');

      // Show typing indicator
      addTypingIndicator();

      // Get AI response
      const response = await sendMessage(message);

      // Remove typing indicator and add response
      removeTypingIndicator();
      addMessage(response, false);

      // Re-enable input
      messageInput.disabled = false;
      sendButton.disabled = false;
      uploadButton.disabled = false;
      messageInput.focus();
    });

    // Focus input on load
    window.addEventListener('load', () => {
      messageInput.focus();
    });
  </script>

</body>

</html>
